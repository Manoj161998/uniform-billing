<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Uniform Billing ‚Äì Quick Entry</title>
<style>
:root {
  --bg: #f5f6fa; --card: #fff; --accent: #0b6e4f; --muted: #6b7280;
}
* { box-sizing: border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
body { margin: 0; background: var(--bg); color: #111; padding: 12px; }
.container { max-width: 950px; margin: auto; }
header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; flex-wrap: wrap; }
.logo { background: var(--accent); color: #fff; padding: 8px 16px; border-radius: 6px; font-weight: 700; }
table { width: 100%; border-collapse: collapse; background: var(--card); box-shadow: 0 2px 6px rgba(0,0,0,0.05); border-radius: 8px; overflow: hidden; margin-bottom:12px;}
th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
th { background: #f0f2f5; color: var(--muted); font-weight: 600; }
select, input, button { padding: 6px 8px; border-radius: 6px; border: 1px solid #dcdfe3; font-size: 14px; width: 100%; }
input[readonly] { background: #f9fafb; }
.btn-print, .btn-whatsapp { background: var(--accent); color: white; border: none; padding: 10px 16px; border-radius: 8px; font-weight: 600; margin-top: 12px; cursor:pointer; }
.btn-download { background:#2b7bdc; color:#fff; border:none; padding:10px 16px; border-radius:8px; font-weight:600; margin-top:12px; cursor:pointer; }  
.right { text-align: right; }
footer { text-align: center; margin-top: 14px; color: var(--muted); font-size: 13px; }
.exchange-toggle { margin: 10px 0; display: flex; align-items: center; gap: 8px; }

@media (max-width: 600px) {
  th, td { font-size: 13px; padding: 8px; }
  select, input { 
    font-size: 12px;  
    padding: 4px; 
    width: 100%; 
    -webkit-appearance: none; 
    appearance: none;
    background-color: #fff; 
    color: #111;
  }
  .btn-print, .btn-whatsapp { width: 100%; }
}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo">Uniform Billing</div>
  </header>

  <div class="exchange-toggle">
    <label><input type="checkbox" id="exchangeMode"> Exchange Mode (Size Change)</label>
  </div>

  <table id="billTable">
    <thead>
      <tr>
        <th>Item</th>
        <th>Old Size</th>
        <th>New Size</th>
        <th>Unit Price (‚Çπ)</th>
        <th>Qty</th>
        <th>Total / Diff (‚Çπ)</th>
      </tr>
    </thead>
    <tbody id="billBody"></tbody>
    <tfoot>
      <tr style="background:#fafafa;font-weight:600;">
        <td colspan="5" class="right">Total Quantity</td>
        <td id="totalQty" class="right">0</td>
      </tr>
      <tr style="background:#fafafa;font-weight:600;">
        <td colspan="5" class="right">Grand Total</td>
        <td id="grandTotal" class="right">‚Çπ0.00</td>
      </tr>
    </tfoot>
  </table>

  <label for="customerNumber">Customer WhatsApp Number (India):</label>
  <input type="tel" id="customerNumber" placeholder="Enter 10-digit number (e.g. 9876543210)" pattern="[0-9]{10}" maxlength="10" />

  <label for="invoiceImage">Shop / QR Image:</label>
  <div style="text-align:center;margin-bottom:10px;">
    <img src="barcode.jpg" alt="Shop Logo or QR" id="invoiceImage"
         style="max-width:250px;width:100%;border:1px solid #ccc;border-radius:8px;padding:5px;">
  </div>

  <label for="paymentMethod">Payment Method:</label>
  <select id="paymentMethod">
    <option value="Cash">Cash</option>
    <option value="Card">Card</option>
    <option value="Paytm">Paytm</option>
  </select>
  
  <button class="btn-print" onclick="window.print()">üñ®Ô∏è Print / Save Invoice</button>
  <button class="btn-whatsapp" onclick="sendWhatsApp()">üí¨ Send via WhatsApp</button>
  <button class="btn-download" onclick="downloadSales()">‚¨áÔ∏è Download Sales CSV</button>

  <footer>Simple & Fast Billing ‚Äî Mobile + Desktop Ready</footer>
</div>

<script>
// --- Helper ---
function idSafe(name) {
  return name.trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
}

// --- Price Data ---
const priceList = {
  "Full Sleeve Shirt": {30:720,32:750,34:780,36:810,38:850,40:900,42:930,44:980,46:1030},
  "Full Pant": {},
  "Full Sleeve Sweater": {30:710,32:730,34:760,36:790,38:800,40:850,42:900,44:950,46:1000},
  "Sleeveless Sweater": {30:600,32:650,34:700,36:750,38:790,40:830,42:850,44:880,46:910},
  "Blazer": {30:2450,32:2480,34:2510,36:2540,38:2570,40:2600,42:2650,44:2700,46:2750,48:2800,50:2850}, 
  "Regular Blue": {20:1570,22:1650,24:1700,26:1750,28:1800,30:1850,32:1900,34:1950,36:2000,38:2050,40:2100,42:2150},
  "Regular Blue Lower": {20:660,22:690,24:720,26:760,28:790,30:820,32:850,34:900,36:950,38:1000,40:1050,42:1100},
  "Sweat T-Shirt BLUE": {20:1040,22:1090,24:1140,26:1290,28:1340,30:1390,32:1440,34:1490,36:1540,38:1590,40:1640,42:1690},
  "Regular Mehroon": {20:1570,22:1650,24:1700,26:1750,28:1800,30:1850,32:1900,34:1950,36:2000,38:2050,40:2100,42:2150},
  "Regular Mehroon Lower": {20:660,22:690,24:720,26:760,28:790,30:820,32:850,34:900,36:950,38:1000,40:1050,42:1100},
  "Sweat T-Shirt MEHROON": {20:1040,22:1090,24:1140,26:1290,28:1340,30:1390,32:1440,34:1490,36:1540,38:1590,40:1640,42:1690},
  "House BLUE": {20:660,22:690,24:720,26:760,28:790,30:820,32:850,34:900,36:950,38:1000,40:1050,42:1100,44:1130,46:1160,48:1190,50:1220,52:1250},
  "House YELLOW": {20:660,22:690,24:720,26:760,28:790,30:820,32:850,34:900,36:950,38:1000,40:1050,42:1100,44:1130,46:1160,48:1190,50:1220,52:1250},
  "House RED": {20:660,22:690,24:720,26:760,28:790,30:820,32:850,34:900,36:950,38:1000,40:1050,42:1100,44:1130,46:1160,48:1190,50:1220,52:1250},
  "House GREEN": {20:660,22:690,24:720,26:760,28:790,30:820,32:850,34:900,36:950,38:1000,40:1050,42:1100,44:1130,46:1160,48:1190,50:1220,52:1250},
  "House Lower": {20:510,22:540,24:570,26:610,28:640,30:670,32:700,34:750,36:800,38:850,40:900,42:950,44:1000,46:1030,48:1060,50:1090,52:1120},
  "Mehroon Socks": {1:130,2:130,3:130,4:145,5:145,6:160,7:160,8:160},
  "Blue Socks": {1:130,2:130,3:130,4:145,5:145,6:160,7:160,8:160},
  "House Socks": {1:130,2:130,3:130,4:145,5:145,6:160,7:160,8:160},
  "Cap": {"All":260},
  "Belt": {"All":160}
};

// Full Pant price table
const fullPantLengthRate = {30:1110,32:1160,34:1210,36:1300,38:1380,40:1420,42:1470,44:1510,46:1550};
for(let L in fullPantLengthRate){
  for(let W=28; W<=50; W+=2){
    priceList["Full Pant"][`${L}x${W}`] = fullPantLengthRate[L];
  }
}

const items = Object.keys(priceList);
const tbody = document.getElementById("billBody");
const grandTotalEl = document.getElementById("grandTotal");
const totalQtyEl = document.getElementById("totalQty");
const exchangeToggle = document.getElementById("exchangeMode");

// --- Build Table ---
items.forEach(item => {
  addItemRow(item);
});

function addItemRow(item, isExtra = false, afterRow = null) {
  const tr = document.createElement('tr');
  const sizeOptions = Object.keys(priceList[item]).map(s => `<option value="${s}">${s}</option>`).join('');

  tr.innerHTML = `
    <td>${item}${isExtra ? " (extra)" : ""}</td>
    <td><select class="old-size" disabled><option value="">Select</option>${sizeOptions}</select></td>
    <td><select class="new-size"><option value="">Select</option>${sizeOptions}</select></td>
    <td><input type="number" class="price" readonly></td>
    <td><input type="number" class="qty" min="0" value="0"></td>
    <td class="right total">‚Çπ0.00</td>
    <td><button class="add-extra">‚ûï</button></td>
  `;

  const addBtn = tr.querySelector(".add-extra");
  addBtn.style = "border:none;background:#0b6e4f;color:#fff;padding:3px 8px;border-radius:4px;cursor:pointer;";
  addBtn.title = "Add another size for same item";

  addBtn.onclick = () => {
    // Add new row just below this one
    const nextRow = tr.nextSibling;
    const newRow = addItemRow(item, true, tr);
    tbody.insertBefore(newRow, nextRow);
  };

  // If it's an extra row, apply light highlight
  if (isExtra) tr.style.background = "#f9f9f9";

  // Return the created row (so caller can insert precisely)
  if (afterRow) {
    tbody.insertBefore(tr, afterRow.nextSibling);
  } else {
    tbody.appendChild(tr);
  }

  return tr;
}


// --- Event Listeners ---
exchangeToggle.addEventListener("change", () => {
  document.querySelectorAll(".old-size").forEach(inp => inp.disabled = !exchangeToggle.checked);
  updateTotals();
});

// Prefill price & quantity on size select
tbody.addEventListener("change", e => {
  if(e.target.classList.contains("new-size")){
    const sel = e.target;
    const row = sel.closest("tr");
    const item = row.cells[0].innerText.trim();
    const priceEl = row.querySelector(`#price-${idSafe(item)}`);
    const qtyEl = row.querySelector(`#qty-${idSafe(item)}`);
    if(!priceEl || !qtyEl) return;

    const newSize = sel.value;
    let newPrice = 0;

    if(item==="Full Pant" && newSize.includes("x")){
      const len = parseInt(newSize.split("x")[0]);
      if(fullPantLengthRate[len]!==undefined) newPrice = fullPantLengthRate[len];
    } else if(priceList[item] && priceList[item][newSize]!==undefined){
      newPrice = priceList[item][newSize];
    } else if(priceList[item] && priceList[item]["All"]!==undefined){
      newPrice = priceList[item]["All"];
    }

    priceEl.value = newPrice || "";
    if(Number(qtyEl.value)===0) qtyEl.value = 1;
    updateTotals();
  }
});

tbody.addEventListener("input", updateTotals);

function updateTotals() {
  let grand = 0, totalQty = 0;
  const exchangeMode = exchangeToggle.checked;

  document.querySelectorAll("#billBody tr").forEach(row => {
    const item = row.cells[0].innerText.replace("(extra)", "").trim();
    const newSize = row.querySelector(".new-size")?.value || "";
    const oldSize = row.querySelector(".old-size")?.value || "";
    const qtyEl = row.querySelector(".qty");
    const priceEl = row.querySelector(".price");
    const totalEl = row.querySelector(".total");

    let newPrice = 0, oldPrice = 0;

    if (item === "Full Pant" && newSize.includes("x")) {
      const len = parseInt(newSize.split("x")[0]);
      if (fullPantLengthRate[len] !== undefined) newPrice = fullPantLengthRate[len];
    } else if (priceList[item] && priceList[item][newSize] !== undefined) {
      newPrice = priceList[item][newSize];
    } else if (priceList[item] && priceList[item]["All"] !== undefined) {
      newPrice = priceList[item]["All"];
    }

    if (exchangeMode && oldSize) {
      if (priceList[item] && priceList[item][oldSize] !== undefined) oldPrice = priceList[item][oldSize];
      else if (priceList[item] && priceList[item]["All"] !== undefined) oldPrice = priceList[item]["All"];
    }

    if (priceEl) priceEl.value = newPrice || "";
    const qty = Number(qtyEl?.value) || 0;
    let total = exchangeMode ? (newPrice - oldPrice) * qty : newPrice * qty;
    if (totalEl) totalEl.textContent = "‚Çπ" + total.toFixed(2);
    grand += total;
    totalQty += qty;
  });

  grandTotalEl.textContent = "‚Çπ" + grand.toFixed(2);
  totalQtyEl.textContent = totalQty;
}

  // --- SAVE SALES IN CSV FORMAT ---
function saveSaleToLocal(invoiceData){
  const prev=JSON.parse(localStorage.getItem("salesCSV")||"[]");
  prev.push(invoiceData);
  localStorage.setItem("salesCSV",JSON.stringify(prev));
}
  
  function downloadSales(){
  const all=JSON.parse(localStorage.getItem("salesCSV")||"[]");
  if(!all.length){alert("No sales data available.");return;}
  const header=Object.keys(all[0]).join(",");
  const rows=all.map(r=>Object.values(r).map(v=>`"${v}"`).join(","));
  const csv=[header,...rows].join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="sales_data.csv";
  a.click();
}

function sendWhatsApp(){
  updateTotals();
  const num=document.getElementById("customerNumber").value.trim();
  if(!/^[0-9]{10}$/.test(num)) return alert("Enter valid 10-digit number.");
  const wa="91"+num;
  const exchangeMode=exchangeToggle.checked;
  const dt=new Date();
  const dateTime=dt.toLocaleString('en-IN',{hour12:true});
  const payment=document.getElementById("paymentMethod").value;

  let msg=`*Invoice*\nDate: ${dateTime}\n`;
  msg+=exchangeMode?"Mode: *Exchange (Size Change)*\n\n":"\n";

  let saleRows=[];
  items.forEach(item=>{
    const row=[...tbody.rows].find(r=>r.cells[0].innerText.trim()===item);
    const qty=row.querySelector(`#qty-${idSafe(item)}`).value;
    if(Number(qty)>0){
      const ns=row.querySelector(".new-size").value;
      const os=row.querySelector(".old-size").value;
      const total=row.querySelector(`#total-${idSafe(item)}`).textContent.replace("‚Çπ","");
      msg+=exchangeMode
        ? `${item} | Old: ${os} ‚Üí New: ${ns} | Qty: ${qty} | Diff: ‚Çπ${total}\n`
        : `${item} | Size: ${ns} | Qty: ${qty} | Total: ‚Çπ${total}\n`;
      saleRows.push({date:dateTime,mode:exchangeMode?"Exchange":"Normal",item,oldSize:os,newSize:ns,qty,total,payment,customer:num});
    }
  });

  msg+=`\n*Total Qty:* ${totalQtyEl.textContent}`;
  msg+=`\n*Grand Total:* ${grandTotalEl.textContent}`;
  msg+=`\n*Payment:* ${payment}`;

  // Save each sale row to localStorage
  saleRows.forEach(saveSaleToLocal);

  // --- Send to Google Sheets ---

  // Save each sale row to localStorage (unchanged)
  saleRows.forEach(saveSaleToLocal);

  // --- Send full invoice (single POST) to Google Sheets ---
  const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzR0ZnWVSgW373iNrraHxxtpELMLkMBXMhvwNxvISbKiIwAgN_bATLZhkZMv9az-8I6/exec"; // <-- replace with your actual Web App URL from Apps Script

  // Build billData (one object per invoice)
  const dt2 = new Date();
  const date = dt2.toISOString().slice(0,10);
  const billData = {
    date: date,
    dateTime: dateTime,
    customer: num,
    payment: payment,
    mode: exchangeMode ? "Exchange" : "Normal",
    totalQty: totalQtyEl.textContent,
    totalAmt: grandTotalEl.textContent.replace("‚Çπ",""),
    items: saleRows.map(it => ({
      item: it.item,
      newSize: it.newSize || it.size || "",
      oldSize: it.oldSize || "",
      qty: it.qty,
      total: it.total
    }))
  };

  // Send one POST (no-cors is OK for simple blind POST; Apps Script will receive it)
    // Send to Google Sheets first, then open WhatsApp (works on mobile)
  const sendToSheet = async () => {
    try {
      await fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(billData)
      });
    } catch (err) {
      console.warn("Google Sheet save error:", err);
    } finally {
      // Always open WhatsApp after a short delay
      setTimeout(() => {
        window.open(`https://wa.me/${wa}?text=${encodeURIComponent(msg)}`, "_blank");
      }, 800);
    }
  };

  sendToSheet();

}
</script>
</body>
</html>





